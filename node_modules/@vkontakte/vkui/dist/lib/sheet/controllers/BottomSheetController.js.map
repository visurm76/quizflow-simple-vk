{"version":3,"sources":["../../../../src/lib/sheet/controllers/BottomSheetController.ts"],"sourcesContent":["import { noop } from '@vkontakte/vkjs';\nimport { clamp } from '../../../helpers/math';\nimport { rubberbandIfOutOfBounds } from '../../animation';\nimport { getNearestOverflowAncestor, hasSelectionWithRangeType } from '../../dom';\nimport { UIPanGestureRecognizer } from '../../touch/UIPanGestureRecognizer';\nimport {\n  BLOCK_SHEET_BEHAVIOR_DATA_ATTRIBUTE_KEY,\n  DRAG_THRESHOLDS,\n  DYNAMIC_SNAP_POINT_DATA,\n  SNAP_POINT_DETENTS,\n} from '../constants';\nimport type { CSSTransitionController } from './CSSTransitionController';\n\nexport type SnapPointDetents = [number, number] | [number, number, number];\n\nexport type SnapPoint = 'auto' | { initial: number; detents: SnapPointDetents };\n\nexport type SnapPointChange = (snapPoint: number) => void;\n\nexport type BottomSheetControllerOptions = {\n  sheetScrollEl: HTMLElement | null;\n  sheetTransitionController: CSSTransitionController<string>;\n  backdropTransitionController: CSSTransitionController | null;\n  onSnapPointChange: SnapPointChange;\n  onDismiss: VoidFunction;\n};\n\nexport class BottomSheetController {\n  private readonly sheetEl: HTMLElement;\n\n  constructor(\n    sheetEl: HTMLElement,\n    {\n      sheetScrollEl,\n      sheetTransitionController,\n      backdropTransitionController,\n      onSnapPointChange,\n      onDismiss,\n    }: BottomSheetControllerOptions,\n  ) {\n    this.sheetEl = sheetEl;\n    this.onSnapPointChange = onSnapPointChange;\n    this.onDismiss = onDismiss;\n    this.panGestureRecognizer = new UIPanGestureRecognizer();\n    this.sheetScrollEl = sheetScrollEl;\n    this.sheetTransitionController = sheetTransitionController;\n    this.backdropTransitionController = backdropTransitionController;\n  }\n\n  init(snapPoint: SnapPoint) {\n    this.isInitialized = true;\n\n    if (snapPoint === 'auto') {\n      this.unit = 'px';\n      this.currentSnapPoint = DYNAMIC_SNAP_POINT_DATA.IDLE_POINT_VALUE;\n      this.snapPointDetents = [SNAP_POINT_DETENTS.MIN, DYNAMIC_SNAP_POINT_DATA.IDLE_POINT_VALUE];\n    } else {\n      this.unit = '%';\n      this.currentSnapPoint = snapPoint.initial;\n      this.snapPointDetents = snapPoint.detents;\n    }\n  }\n\n  destroy() {\n    this.isInitialized = false;\n    this.pannedEl = null;\n    this.sheetTransitionController.cleanup();\n    this.backdropTransitionController?.cleanup();\n\n    this.disableVerticalScrollBouncingDispose();\n    this.disableVerticalScrollBouncingDispose = noop;\n  }\n\n  panStart(event: UIEvent) {\n    if (\n      !this.isInitialized ||\n      this.panState !== 'idle' ||\n      hasSelectionWithRangeType(event.target)\n    ) {\n      return;\n    }\n\n    this.panState = 'start';\n    this.pannedEl = event.target as HTMLElement;\n    this.panGestureRecognizer.setStartCoords(event);\n  }\n\n  panMove(event: UIEvent) {\n    switch (this.panState) {\n      case 'start':\n        this.panGestureRecognizer.setInitialTimeOnce();\n        this.panGestureRecognizer.setEndCoords(event);\n\n        if (this.preventUntilPanGestureBecomesExpected()) {\n          return;\n        }\n\n        if (this.preventImmediatelyIfPannedElIsNotValid()) {\n          this.panState = 'idle';\n          return;\n        }\n\n        if (this.preventUntilVerticalScrollingOnSheetScrollElBecomesExpected()) {\n          return;\n        }\n\n        if (this.preventImmediatelyIfVerticalScrollingOnPannedElIsScrolled()) {\n          this.panState = 'idle';\n          return;\n        }\n\n        this.panState = 'moving';\n        this.panGestureRecognizer.setStartCoords(event);\n\n        this.sheetHeight = this.sheetEl.offsetHeight;\n\n        this.disableVerticalScrollBouncingDispose =\n          BottomSheetController.disableVerticalScrollBouncingIfNeeded(\n            this.sheetScrollEl,\n            this.pannedEl,\n          );\n\n        if (this.isDynamicSnapPoint) {\n          this.currentSnapPoint = this.sheetHeight;\n          this.snapPointDetents[DYNAMIC_SNAP_POINT_DATA.COMPUTED_INDEX] = this.sheetHeight;\n        }\n        break;\n      case 'moving':\n        this.panGestureRecognizer.setEndCoords(event);\n\n        const { y1, y2 } = this.panGestureRecognizer;\n\n        this.nextSnapPoint = rubberbandIfOutOfBounds(\n          this.currentSnapPoint - ((y2 - y1) / this.sheetHeight) * this.currentSnapPoint,\n          SNAP_POINT_DETENTS.MIN,\n          this.isDynamicSnapPoint ? this.sheetHeight : SNAP_POINT_DETENTS.LARGE,\n        );\n\n        this.calculateSnapPoint(this.nextSnapPoint, true);\n        break;\n    }\n  }\n\n  panEnd() {\n    switch (this.panState) {\n      case 'moving':\n        const prevCurrentSnapPoint = this.currentSnapPoint;\n        this.currentSnapPoint = this.getSnapPointTo(this.nextSnapPoint);\n\n        if (\n          prevCurrentSnapPoint !== this.currentSnapPoint &&\n          this.currentSnapPoint > SNAP_POINT_DETENTS.MIN\n        ) {\n          this.onSnapPointChange(this.currentSnapPoint);\n        }\n\n        this.calculateSnapPoint(this.currentSnapPoint);\n        break;\n    }\n\n    this.panState = 'idle';\n    this.panGestureRecognizer.reset();\n\n    this.disableVerticalScrollBouncingDispose();\n    this.disableVerticalScrollBouncingDispose = noop;\n  }\n\n  private isInitialized = false;\n  private panState: 'idle' | 'start' | 'moving' = 'idle';\n  private pannedEl: HTMLElement | null = null;\n  private sheetHeight = 0;\n  private rafId: number | null = null;\n  private currentSnapPoint = 0;\n  private nextSnapPoint = 0;\n  private snapPointDetents: SnapPointDetents = [0, 0];\n  private unit: 'px' | '%' = '%';\n  private get isDynamicSnapPoint() {\n    return this.unit === 'px';\n  }\n  private disableVerticalScrollBouncingDispose = noop;\n  private readonly sheetScrollEl: HTMLElement | null;\n  private readonly sheetTransitionController: CSSTransitionController<string>;\n  private readonly backdropTransitionController: CSSTransitionController | null;\n  private readonly panGestureRecognizer: UIPanGestureRecognizer;\n  private readonly onSnapPointChange: SnapPointChange;\n  private readonly onDismiss: VoidFunction;\n\n  private calculateSnapPoint(nextSnapPoint: number, immediately = false) {\n    if (this.rafId !== null) {\n      cancelAnimationFrame(this.rafId);\n    }\n\n    if (nextSnapPoint <= SNAP_POINT_DETENTS.MIN) {\n      this.sheetTransitionController.enableTransition();\n      this.backdropTransitionController?.enableTransition();\n      this.panState = 'idle';\n      this.onDismiss();\n      return;\n    }\n\n    const backdropOpacity = clamp(\n      this.isDynamicSnapPoint\n        ? nextSnapPoint / this.sheetHeight\n        : (nextSnapPoint * 2) / SNAP_POINT_DETENTS.LARGE,\n      0,\n      1,\n    );\n\n    this.rafId = requestAnimationFrame(() => {\n      if (immediately) {\n        this.backdropTransitionController?.disableTransition().set(backdropOpacity);\n        this.sheetTransitionController.disableTransition().set(`${nextSnapPoint}${this.unit}`);\n        return;\n      }\n\n      if (this.isDynamicSnapPoint) {\n        this.sheetTransitionController.cleanupOnTransitionEnd();\n      }\n\n      this.backdropTransitionController?.unset();\n      this.sheetTransitionController.enableTransition().set(`${this.currentSnapPoint}${this.unit}`);\n    });\n  }\n\n  private getSnapPointTo(nextSnapPoint: number) {\n    const closestSnapPoint = BottomSheetController.getClosestSnapPoint(\n      this.snapPointDetents,\n      nextSnapPoint,\n    );\n    if (closestSnapPoint !== this.currentSnapPoint) {\n      return closestSnapPoint;\n    }\n\n    const panDirection = this.panGestureRecognizer.direction();\n    if (panDirection.axis !== 'y' || panDirection.direction === null) {\n      return this.currentSnapPoint;\n    }\n\n    const velocity = this.panGestureRecognizer.velocity();\n    if (Math.abs(velocity.y) < DRAG_THRESHOLDS.VELOCITY) {\n      return this.currentSnapPoint;\n    }\n\n    const closestSnapPointByDirection = BottomSheetController.getClosestSnapPointByDirection(\n      this.snapPointDetents,\n      closestSnapPoint,\n      panDirection.direction,\n    );\n\n    return closestSnapPointByDirection;\n  }\n\n  private preventUntilPanGestureBecomesExpected() {\n    return (\n      this.panGestureRecognizer.direction().axis === 'x' ||\n      this.panGestureRecognizer.distance() < DRAG_THRESHOLDS.DISTANCE_FOR_MOVING_START\n    );\n  }\n\n  private preventImmediatelyIfPannedElIsNotValid() {\n    return (\n      this.pannedEl === null ||\n      // Элемент со специальным атрибутом\n      this.pannedEl.closest(`[${BLOCK_SHEET_BEHAVIOR_DATA_ATTRIBUTE_KEY}=true]`) !== null || // eslint-disable-line no-restricted-properties\n      // Элемент за пределами панели.\n      !this.sheetEl.contains(this.pannedEl)\n    );\n  }\n\n  private preventUntilVerticalScrollingOnSheetScrollElBecomesExpected() {\n    if (\n      this.sheetScrollEl === null ||\n      !this.sheetScrollEl.contains(this.pannedEl) ||\n      this.sheetScrollEl.scrollHeight <= this.sheetScrollEl.clientHeight\n    ) {\n      return false;\n    }\n\n    if (this.sheetScrollEl.scrollTop === 0) {\n      return (\n        this.panGestureRecognizer.direction().direction === -1 &&\n        BottomSheetController.isLastSnapPointDetents(this.snapPointDetents, this.currentSnapPoint)\n      );\n    }\n\n    return true;\n  }\n\n  private preventImmediatelyIfVerticalScrollingOnPannedElIsScrolled() {\n    if (\n      /* istanbul ignore next: покрываем TypeScript */\n      this.pannedEl === null ||\n      this.pannedEl === this.sheetEl ||\n      this.pannedEl === this.sheetScrollEl\n    ) {\n      return false;\n    }\n\n    const overflowAncestor = getNearestOverflowAncestor(this.pannedEl, this.sheetEl);\n\n    if (\n      overflowAncestor === null ||\n      this.sheetScrollEl === overflowAncestor ||\n      overflowAncestor.scrollHeight <= overflowAncestor.clientHeight\n    ) {\n      return false;\n    }\n\n    return (\n      overflowAncestor.scrollTop !== 0 || this.panGestureRecognizer.direction().direction === -1\n    );\n  }\n\n  private static disableVerticalScrollBouncingIfNeeded(\n    sheetScrollEl: HTMLElement | null,\n    targetEl: HTMLElement | null,\n  ) {\n    if (\n      sheetScrollEl !== null &&\n      sheetScrollEl.scrollTop <= 0 &&\n      sheetScrollEl.contains(targetEl) &&\n      sheetScrollEl.scrollHeight > sheetScrollEl.clientHeight\n    ) {\n      sheetScrollEl.style.setProperty('overflow-y', 'hidden');\n      return function dispose() {\n        sheetScrollEl.style.removeProperty('overflow-y');\n      };\n    }\n    return noop;\n  }\n\n  private static isLastSnapPointDetents(\n    snapPointDetents: SnapPointDetents,\n    currentY: number,\n  ): boolean {\n    return currentY === snapPointDetents[snapPointDetents.length - 1];\n  }\n\n  private static getClosestSnapPointByDirection(\n    snapPointDetents: SnapPointDetents,\n    currentY: number,\n    direction: -1 | 1,\n  ): number {\n    const foundIndex = snapPointDetents.indexOf(currentY);\n    switch (direction) {\n      case -1:\n        return snapPointDetents[foundIndex + 1] ?? snapPointDetents[snapPointDetents.length - 1];\n      case 1:\n        return snapPointDetents[foundIndex - 1] ?? snapPointDetents[0];\n    }\n  }\n\n  private static getClosestSnapPoint(snapPointDetents: SnapPointDetents, currentY: number) {\n    let closest = snapPointDetents[0];\n    let minDifference = Math.abs(snapPointDetents[0] - currentY);\n\n    for (let i = 1; i < snapPointDetents.length; i += 1) {\n      const difference = Math.abs(snapPointDetents[i] - currentY);\n      if (difference < minDifference) {\n        closest = snapPointDetents[i];\n        minDifference = difference;\n      }\n    }\n\n    return closest;\n  }\n}\n"],"names":["noop","clamp","rubberbandIfOutOfBounds","getNearestOverflowAncestor","hasSelectionWithRangeType","UIPanGestureRecognizer","BLOCK_SHEET_BEHAVIOR_DATA_ATTRIBUTE_KEY","DRAG_THRESHOLDS","DYNAMIC_SNAP_POINT_DATA","SNAP_POINT_DETENTS","BottomSheetController","init","snapPoint","isInitialized","unit","currentSnapPoint","IDLE_POINT_VALUE","snapPointDetents","MIN","initial","detents","destroy","pannedEl","sheetTransitionController","cleanup","backdropTransitionController","disableVerticalScrollBouncingDispose","panStart","event","panState","target","panGestureRecognizer","setStartCoords","panMove","setInitialTimeOnce","setEndCoords","preventUntilPanGestureBecomesExpected","preventImmediatelyIfPannedElIsNotValid","preventUntilVerticalScrollingOnSheetScrollElBecomesExpected","preventImmediatelyIfVerticalScrollingOnPannedElIsScrolled","sheetHeight","sheetEl","offsetHeight","disableVerticalScrollBouncingIfNeeded","sheetScrollEl","isDynamicSnapPoint","COMPUTED_INDEX","y1","y2","nextSnapPoint","LARGE","calculateSnapPoint","panEnd","prevCurrentSnapPoint","getSnapPointTo","onSnapPointChange","reset","immediately","rafId","cancelAnimationFrame","enableTransition","onDismiss","backdropOpacity","requestAnimationFrame","disableTransition","set","cleanupOnTransitionEnd","unset","closestSnapPoint","getClosestSnapPoint","panDirection","direction","axis","velocity","Math","abs","y","VELOCITY","closestSnapPointByDirection","getClosestSnapPointByDirection","distance","DISTANCE_FOR_MOVING_START","closest","contains","scrollHeight","clientHeight","scrollTop","isLastSnapPointDetents","overflowAncestor","targetEl","style","setProperty","dispose","removeProperty","currentY","length","foundIndex","indexOf","minDifference","i","difference"],"mappings":"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"}