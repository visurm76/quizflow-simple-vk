{"version":3,"sources":["../../../src/hooks/useFocusTrap.ts"],"sourcesContent":["import { type RefObject, useRef, useState } from 'react';\nimport { arraysEquals } from '../helpers/array';\nimport { FOCUSABLE_ELEMENTS_LIST, Keys, pressedKey } from '../lib/accessibility';\nimport {\n  contains,\n  getActiveElementByAnotherElement,\n  getWindow,\n  isHTMLElement,\n  useDOM,\n} from '../lib/dom';\nimport { useIsomorphicLayoutEffect } from '../lib/useIsomorphicLayoutEffect';\nimport { useMutationObserver } from './useMutationObserver';\nimport { useStableCallback } from './useStableCallback';\n\nfunction isFocusableElement(el: Element): boolean {\n  // eslint-disable-next-line no-restricted-properties\n  return FOCUSABLE_ELEMENTS_LIST.some((sel) => el.matches(sel));\n}\n\nconst useRestoreFocus = ({\n  restoreFocus,\n  timeout,\n  mount,\n  ref,\n}: Pick<UseFocusTrapProps, 'restoreFocus' | 'timeout' | 'mount'> & {\n  ref: RefObject<HTMLElement | null>;\n}) => {\n  const restoreFocusRef = useRef(restoreFocus);\n  restoreFocusRef.current = restoreFocus;\n  const [restoreFocusTo, setRestoreFocusTo] = useState<Element | null>(null);\n\n  const restoreFocusImpl = useStableCallback(() => {\n    const shouldRestoreFocus =\n      typeof restoreFocusRef.current === 'function'\n        ? restoreFocusRef.current()\n        : restoreFocusRef.current;\n\n    if (!shouldRestoreFocus) {\n      return;\n    }\n\n    const activeElement = getActiveElementByAnotherElement(ref.current);\n    if (\n      activeElement &&\n      !ref.current?.contains(activeElement) &&\n      isFocusableElement(activeElement)\n    ) {\n      return;\n    }\n\n    setTimeout(() => {\n      const restoreFocusElement =\n        (isHTMLElement(shouldRestoreFocus) && shouldRestoreFocus) ||\n        (isHTMLElement(restoreFocusTo) && restoreFocusTo) ||\n        null;\n\n      if (restoreFocusElement) {\n        restoreFocusElement.focus();\n        setRestoreFocusTo(null);\n      }\n    }, timeout);\n  });\n\n  useIsomorphicLayoutEffect(\n    function calculateRestoreFocusTo() {\n      if (!ref.current || !restoreFocusRef.current || !mount) {\n        setRestoreFocusTo(null);\n        return;\n      }\n      setRestoreFocusTo(getActiveElementByAnotherElement(ref.current));\n    },\n    [ref, mount],\n  );\n\n  useIsomorphicLayoutEffect(\n    function tryToRestoreFocusOnUnmount() {\n      return () => {\n        restoreFocusImpl();\n      };\n    },\n    [restoreFocusImpl],\n  );\n\n  useIsomorphicLayoutEffect(\n    function tryToRestoreFocusWhenFakeUnmount() {\n      if (!mount) {\n        restoreFocusImpl();\n      }\n    },\n    [mount, restoreFocusImpl],\n  );\n};\n\nconst FOCUSABLE_ELEMENTS: string = FOCUSABLE_ELEMENTS_LIST.join();\n\nexport type UseFocusTrapProps = {\n  /**\n   * @default true\n   */\n  mount?: boolean;\n  /**\n   * Форсированное отключение захвата фокуса\n   *\n   * @default false\n   */\n  disabled?: boolean;\n  /**\n   * @default true\n   */\n  autoFocus?: boolean | 'root';\n  /**\n   * @default true\n   */\n  restoreFocus?: boolean | (() => boolean | HTMLElement);\n  /**\n   * @default 0\n   */\n  timeout?: number;\n  /**\n   * Вызывается при нажатии на кнопку `Escape`.\n   */\n  onClose?: VoidFunction;\n  /**\n   * Следует ли обрабатываеть событие нажатия клавиши Escape при \"погружении\", то есть\n   * до того как это событие будет обработано на EventTarget\n   * Удобно установить в false, если требуется запретить \"всплытие\" события до FocusTrap\n   *\n   * @default true\n   */\n  captureEscapeKeyboardEvent?: boolean;\n  /**\n   * Пользовательские опции для MutationObserver, который отслеживает изменения DOM внутри компонента и пересчитывает ноды для фокуса.\n   */\n  mutationObserverOptions?: MutationObserverInit;\n};\n\n/**\n * @private\n */\nexport const useFocusTrap = (\n  ref: RefObject<HTMLElement | null>,\n  {\n    mount = true,\n    disabled = false,\n    autoFocus = true,\n    restoreFocus = true,\n    timeout = 0,\n    onClose,\n    captureEscapeKeyboardEvent = true,\n    mutationObserverOptions,\n  }: UseFocusTrapProps,\n) => {\n  const { document } = useDOM();\n\n  const focusableNodesRef = useRef<HTMLElement[]>([]);\n\n  const focusNodeByIndex = (nodeIndex: number) => {\n    const element = focusableNodesRef.current[nodeIndex];\n\n    if (element) {\n      element.focus({\n        preventScroll: true,\n      });\n    }\n  };\n\n  useRestoreFocus({\n    restoreFocus,\n    mount,\n    timeout,\n    ref,\n  });\n\n  const recalculateFocusableNodesRef = (parentNode: HTMLElement) => {\n    // eslint-disable-next-line no-restricted-properties\n    const newFocusableElements = parentNode.querySelectorAll<HTMLElement>(FOCUSABLE_ELEMENTS);\n\n    const nodes: HTMLElement[] = [];\n    newFocusableElements.forEach((focusableEl) => {\n      const { display, visibility } = getComputedStyle(focusableEl);\n      if (display !== 'none' && visibility !== 'hidden') {\n        nodes.push(focusableEl);\n      }\n    });\n    if (nodes.length === 0) {\n      // Чтобы фокус был хотя бы на родителе\n      nodes.push(parentNode);\n    }\n    focusableNodesRef.current = nodes;\n  };\n\n  const onMutateParentHandler = (parentNode: HTMLElement) => {\n    const oldFocusableNodes = [...focusableNodesRef.current];\n\n    recalculateFocusableNodesRef(parentNode);\n\n    if (disabled || !autoFocus || arraysEquals(oldFocusableNodes, focusableNodesRef.current)) {\n      return;\n    }\n\n    if (document) {\n      const activeElement = document.activeElement as HTMLElement;\n      const currentElementIndex = Math.max(\n        document.activeElement ? focusableNodesRef.current.indexOf(activeElement) : -1,\n        0,\n      );\n      focusNodeByIndex(currentElementIndex);\n    }\n  };\n\n  useMutationObserver(\n    ref,\n    () => ref.current && onMutateParentHandler(ref.current),\n    mutationObserverOptions,\n  );\n\n  useIsomorphicLayoutEffect(() => {\n    ref.current && recalculateFocusableNodesRef(ref.current);\n  }, [ref]);\n\n  useIsomorphicLayoutEffect(\n    function tryToAutoFocusToFirstNode() {\n      if (!ref.current || !autoFocus || disabled) {\n        return;\n      }\n\n      const autoFocusToNode = () => {\n        if (!ref.current || !focusableNodesRef.current.length) {\n          return;\n        }\n        const activeElement = getActiveElementByAnotherElement(ref.current);\n        if (!contains(ref.current, activeElement)) {\n          if (autoFocus === 'root') {\n            ref.current?.focus();\n          } else {\n            focusableNodesRef.current[0].focus();\n          }\n        }\n      };\n      const timeoutId = setTimeout(autoFocusToNode, timeout);\n      return () => {\n        clearTimeout(timeoutId);\n      };\n    },\n    [autoFocus, timeout, disabled],\n  );\n\n  useIsomorphicLayoutEffect(\n    function initializeFocusTrap() {\n      if (!ref.current) {\n        return;\n      }\n\n      const onDocumentKeydown = (event: KeyboardEvent) => {\n        if (disabled) {\n          return;\n        }\n\n        const pressedKeyResult = pressedKey(event);\n\n        switch (pressedKeyResult) {\n          case Keys.TAB: {\n            if (!focusableNodesRef.current.length) {\n              return false;\n            }\n\n            const lastIdx = focusableNodesRef.current.length - 1;\n            const targetIdx = focusableNodesRef.current.findIndex((node) => node === event.target);\n\n            const shouldFocusFirstNode =\n              targetIdx === -1 || (targetIdx === lastIdx && !event.shiftKey);\n\n            if (shouldFocusFirstNode || (targetIdx === 0 && event.shiftKey)) {\n              event.preventDefault();\n\n              const node = focusableNodesRef.current[shouldFocusFirstNode ? 0 : lastIdx];\n\n              if (node !== getActiveElementByAnotherElement(node)) {\n                node.focus();\n              }\n\n              return false;\n            }\n\n            break;\n          }\n        }\n\n        return true;\n      };\n\n      const onEscapeKeydown = (event: KeyboardEvent) => {\n        if (disabled) {\n          return;\n        }\n\n        const pressedKeyResult = pressedKey(event);\n\n        if (pressedKeyResult === Keys.ESCAPE) {\n          if (onClose) {\n            event.preventDefault();\n            onClose();\n          }\n        }\n\n        return true;\n      };\n\n      const doc = getWindow(ref.current).document;\n      doc.addEventListener('keydown', onDocumentKeydown, {\n        capture: true,\n      });\n      doc.addEventListener('keydown', onEscapeKeydown, {\n        capture: captureEscapeKeyboardEvent,\n      });\n      return () => {\n        doc.removeEventListener('keydown', onDocumentKeydown, true);\n        doc.removeEventListener('keydown', onEscapeKeydown, captureEscapeKeyboardEvent);\n      };\n    },\n    [onClose, ref, disabled],\n  );\n};\n"],"names":["useRef","useState","arraysEquals","FOCUSABLE_ELEMENTS_LIST","Keys","pressedKey","contains","getActiveElementByAnotherElement","getWindow","isHTMLElement","useDOM","useIsomorphicLayoutEffect","useMutationObserver","useStableCallback","isFocusableElement","el","some","sel","matches","useRestoreFocus","restoreFocus","timeout","mount","ref","restoreFocusRef","current","restoreFocusTo","setRestoreFocusTo","restoreFocusImpl","shouldRestoreFocus","activeElement","setTimeout","restoreFocusElement","focus","calculateRestoreFocusTo","tryToRestoreFocusOnUnmount","tryToRestoreFocusWhenFakeUnmount","FOCUSABLE_ELEMENTS","join","useFocusTrap","disabled","autoFocus","onClose","captureEscapeKeyboardEvent","mutationObserverOptions","document","focusableNodesRef","focusNodeByIndex","nodeIndex","element","preventScroll","recalculateFocusableNodesRef","parentNode","newFocusableElements","querySelectorAll","nodes","forEach","focusableEl","display","visibility","getComputedStyle","push","length","onMutateParentHandler","oldFocusableNodes","currentElementIndex","Math","max","indexOf","tryToAutoFocusToFirstNode","autoFocusToNode","timeoutId","clearTimeout","initializeFocusTrap","onDocumentKeydown","event","pressedKeyResult","TAB","lastIdx","targetIdx","findIndex","node","target","shouldFocusFirstNode","shiftKey","preventDefault","onEscapeKeydown","ESCAPE","doc","addEventListener","capture","removeEventListener"],"mappings":"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"}