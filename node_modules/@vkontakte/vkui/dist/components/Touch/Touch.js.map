{"version":3,"sources":["../../../src/components/Touch/Touch.tsx"],"sourcesContent":["'use client';\n\nimport * as React from 'react';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useStableCallback } from '../../hooks/useStableCallback';\nimport { getWindow, isHTMLElement, isSVGElement } from '../../lib/dom';\nimport { coordX, coordY, touchEnabled, type VKUITouchEvent } from '../../lib/touch';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport type { HasComponent, HasRootRef } from '../../types';\n\ninterface EventWithType {\n  /**\n   * Тип события.\n   */\n  readonly type: string;\n}\n\nfunction isTouchEvent(event: EventWithType) {\n  return event.type.startsWith('touch');\n}\n\ntype CheckEvent = (event: EventWithType) => void;\n\ntype IsEventLock = (event: EventWithType) => boolean;\n\n/**\n * Телефоны после touch событий могут отправлять события мыши,\n * Это может происходить при обычном нажатии.\n *\n * Нельзя использовать хук во время рендеринга.\n */\nfunction useMouseEventLock(): [IsEventLock, CheckEvent] {\n  const isMouseEventLockRef = React.useRef<boolean>(false);\n  const timerRef = React.useRef<ReturnType<typeof setTimeout>>(undefined);\n\n  const isEventLock: IsEventLock = React.useCallback((event: EventWithType) => {\n    return !isTouchEvent(event) && isMouseEventLockRef.current === true;\n  }, []);\n\n  const checkEvent: CheckEvent = React.useCallback((event: EventWithType) => {\n    if (!isTouchEvent(event)) {\n      return;\n    }\n\n    isMouseEventLockRef.current = true;\n\n    clearTimeout(timerRef.current);\n    timerRef.current = setTimeout(() => {\n      isMouseEventLockRef.current = false;\n    }, 1000);\n  }, []);\n\n  React.useEffect(() => () => clearTimeout(timerRef.current), []);\n\n  return [isEventLock, checkEvent];\n}\n\n/**\n * Костыль для правильной работы тайпскрипта.\n */\ntype HTMLorSVGElementWithEvents = {\n  /**\n   * AddEventListener.\n   */\n  addEventListener: (<K extends keyof HTMLElementEventMap>(\n    type: K,\n    listener: (this: HTMLElement, ev: HTMLElementEventMap[K]) => any,\n    options?: boolean | AddEventListenerOptions,\n  ) => void) &\n    (<K extends keyof SVGElementEventMap>(\n      type: K,\n      listener: (this: SVGElement, ev: SVGElementEventMap[K]) => any,\n      options?: boolean | AddEventListenerOptions,\n    ) => void);\n  /**\n   * RemoveEventListener.\n   */\n  removeEventListener: (<K extends keyof HTMLElementEventMap>(\n    type: K,\n    listener: (this: HTMLElement, ev: HTMLElementEventMap[K]) => any,\n    options?: boolean | EventListenerOptions,\n  ) => void) &\n    (<K extends keyof SVGElementEventMap>(\n      type: K,\n      listener: (this: SVGElement, ev: SVGElementEventMap[K]) => any,\n      options?: boolean | EventListenerOptions,\n    ) => void);\n};\n\nexport interface CustomTouchEvent extends Gesture {\n  /**\n   * Оригинальное событие.\n   */\n  originalEvent: VKUITouchEvent;\n}\n\nexport type HoverHandler = (outputEvent: MouseEvent) => void;\n\nexport type CustomTouchEventHandler = (event: CustomTouchEvent) => void;\n\nexport interface TouchProps\n  extends React.AllHTMLAttributes<HTMLElement>,\n    HasRootRef<HTMLElement>,\n    HasComponent {\n  /**\n   * Использовать pointer-events для hover-состояний.\n   * Работает на отключенных элементах (disabled inputs).\n   */\n  usePointerHover?: boolean;\n  /**\n   * Использовать фазу capture для событий.\n   */\n  useCapture?: boolean;\n  /**\n   * Порог расстояния в пикселях для активации свайпа.\n   * @default 5\n   */\n  slideThreshold?: number;\n  /**\n   * Блокировать click-события после распознавания свайпа.\n   */\n  noSlideClick?: boolean;\n  /**\n   * Останавливать всплытие событий.\n   */\n  stopPropagation?: boolean;\n  /**\n   * Обработчик входа курсора в область.\n   */\n  onEnter?: HoverHandler;\n  /**\n   * Обработчик выхода курсора из области.\n   */\n  onLeave?: HoverHandler;\n  /**\n   * Общий обработчик начала взаимодействия.\n   */\n  onStart?: CustomTouchEventHandler;\n  /**\n   * Обработчик начала горизонтального перемещения.\n   */\n  onStartX?: CustomTouchEventHandler;\n  /**\n   * Обработчик начала вертикального перемещения.\n   */\n  onStartY?: CustomTouchEventHandler;\n  /**\n   * Общий обработчик перемещения.\n   */\n  onMove?: CustomTouchEventHandler;\n  /**\n   * Обработчик горизонтального перемещения.\n   */\n  onMoveX?: CustomTouchEventHandler;\n  /**\n   * Обработчик вертикального перемещения.\n   */\n  onMoveY?: CustomTouchEventHandler;\n  /**\n   * Общий обработчик завершения взаимодействия.\n   */\n  onEnd?: CustomTouchEventHandler;\n  /**\n   * Обработчик завершения горизонтального свайпа.\n   */\n  onEndX?: CustomTouchEventHandler;\n  /**\n   * Обработчик завершения вертикального свайпа.\n   */\n  onEndY?: CustomTouchEventHandler;\n}\n\nexport interface Gesture {\n  /**\n   * Начальная X-координата касания.\n   */\n  startX: number;\n\n  /**\n   * Начальная Y-координата касания.\n   */\n  startY: number;\n\n  /**\n   * Время начала взаимодействия.\n   */\n  startT: Date;\n\n  /**\n   * Длительность взаимодействия в миллисекундах.\n   */\n  duration: number;\n\n  /**\n   * Флаг активного нажатия.\n   */\n  isPressed: boolean;\n\n  /**\n   * Флаг вертикального перемещения.\n   */\n  isY: boolean;\n\n  /**\n   * Флаг горизонтального перемещения.\n   */\n  isX: boolean;\n\n  /**\n   * Флаг горизонтального свайпа.\n   */\n  isSlideX: boolean;\n\n  /**\n   * Флаг вертикального свайпа.\n   */\n  isSlideY: boolean;\n\n  /**\n   * Общий флаг свайпа (вертикального или горизонтального).\n   */\n  isSlide: boolean;\n\n  /**\n   * Текущая X-координата курсора/касания.\n   */\n  clientX: number;\n\n  /**\n   * Текущая Y-координата курсора/касания.\n   */\n  clientY: number;\n\n  /**\n   * Смещение по X относительно начальной точки.\n   */\n  shiftX: number;\n\n  /**\n   * Смещение по Y относительно начальной точки.\n   */\n  shiftY: number;\n\n  /**\n   * Абсолютное смещение по X.\n   */\n  shiftXAbs: number;\n\n  /**\n   * Абсолютное смещение по Y.\n   */\n  shiftYAbs: number;\n}\n\n/**\n * @see https://vkui.io/components/touch\n */\nexport const Touch = ({\n  onStart,\n  onStartX,\n  onStartY,\n  onMove,\n  onMoveX,\n  onMoveY,\n  onEnter,\n  onLeave,\n  onEnd,\n  onEndX,\n  onEndY,\n  onClickCapture,\n  usePointerHover,\n  slideThreshold = 5,\n  useCapture = false,\n  Component = 'div',\n  getRootRef,\n  noSlideClick = false,\n  stopPropagation = false,\n  ...restProps\n}: TouchProps) => {\n  const hostRef = useExternRef(getRootRef);\n  const [isTouchEnabled] = React.useState(touchEnabled);\n  const gestureRef = React.useRef<Gesture | null>(null);\n  const didSlide = React.useRef(false);\n  const disposeTargetNativeGestureEvents = React.useRef<VoidFunction | null>(null);\n\n  const [isEventLock, checkEventForLock] = useMouseEventLock();\n\n  const cleanupTargetNativeGestureEvents = () => {\n    gestureRef.current = null;\n    if (disposeTargetNativeGestureEvents.current) {\n      disposeTargetNativeGestureEvents.current();\n      disposeTargetNativeGestureEvents.current = null;\n    }\n  };\n\n  React.useEffect(() => cleanupTargetNativeGestureEvents, []);\n\n  /**\n   * Note: используем `useStableCallback()`, чтобы не терялась область видимости `onEnd`/`onEndX`/`onEndY`.\n   */\n  const handleNativePointerUp = useStableCallback((event: MouseEvent | TouchEvent) => {\n    const gesture = gestureRef.current;\n\n    /* istanbul ignore if: нужно для Typescript */\n    if (!gesture) {\n      return;\n    }\n\n    if (gesture.isPressed) {\n      dispatchUserHandlers(event, gesture, [onEnd, onEndX, onEndY], stopPropagation);\n    }\n\n    if (isTouchEvent(event)) {\n      // https://github.com/VKCOM/VKUI/issues/4414\n      // если тач-устройство и был зафиксирован touchmove,\n      // то событие клика не вызывается\n      if (gesture.isSlide) {\n        didSlide.current = false;\n      }\n      // Если это был тач-евент, симулируем отмену hover\n      if (onLeave) {\n        onLeave(event as MouseEvent);\n      }\n    } else {\n      didSlide.current = Boolean(gesture.isSlide);\n    }\n\n    cleanupTargetNativeGestureEvents();\n  });\n\n  /**\n   * Note: используем `useStableCallback()`, чтобы не терялась область видимости `onMove`/`onMoveX`/`onMoveY`.\n   */\n  const handleNativePointerMove = useStableCallback((event: MouseEvent | TouchEvent) => {\n    const gesture = gestureRef.current;\n\n    /* istanbul ignore if: нужно для Typescript */\n    if (!gesture) {\n      return;\n    }\n\n    const clientX = coordX(event);\n    const clientY = coordY(event);\n\n    // смещения\n    const shiftX = clientX - gesture.startX;\n    const shiftY = clientY - gesture.startY;\n\n    // абсолютные значения смещений\n    const shiftXAbs = Math.abs(shiftX);\n    const shiftYAbs = Math.abs(shiftY);\n\n    // Если определяем мультитач, то прерываем жест\n    if ('touches' in event && event.touches.length > 1) {\n      return handleNativePointerUp(event);\n    }\n\n    // если мы ещё не определились\n    if (!gesture.isX && !gesture.isY) {\n      const willBeX = shiftXAbs >= slideThreshold && shiftXAbs > shiftYAbs;\n      const willBeY = shiftYAbs >= slideThreshold && shiftYAbs > shiftXAbs;\n      const willBeSlidedX = willBeX && (!!onMoveX || !!onMove);\n      const willBeSlidedY = willBeY && (!!onMoveY || !!onMove);\n\n      gesture.isY = willBeY;\n      gesture.isX = willBeX;\n      gesture.isSlideX = willBeSlidedX;\n      gesture.isSlideY = willBeSlidedY;\n      gesture.isSlide = willBeSlidedX || willBeSlidedY;\n    }\n\n    if (gesture.isSlide) {\n      gesture.clientX = clientX;\n      gesture.clientY = clientY;\n      gesture.shiftX = shiftX;\n      gesture.shiftY = shiftY;\n      gesture.shiftXAbs = shiftXAbs;\n      gesture.shiftYAbs = shiftYAbs;\n\n      dispatchUserHandlers(event, gesture, [onMove, onMoveX, onMoveY], stopPropagation);\n    }\n  });\n\n  const handlePointerDown = useStableCallback(\n    (event: React.MouseEvent<HTMLElement> | React.TouchEvent<HTMLElement> | TouchEvent) => {\n      // Если touchstart сэмулировало mousedown, то заканчиваем обработку\n      if (isEventLock(event)) {\n        return;\n      }\n\n      // Помечаем что произошло touch событие\n      checkEventForLock(event);\n\n      if (gestureRef.current !== null) {\n        return;\n      }\n\n      const nativeEvent = 'nativeEvent' in event ? event.nativeEvent : event;\n\n      gestureRef.current = initGesture(coordX(nativeEvent), coordY(nativeEvent));\n\n      const shouldCallDirectionHandlerOnlyIsSlide = false;\n      dispatchUserHandlers(\n        event,\n        gestureRef.current,\n        [onStart, onStartX, onStartY],\n        stopPropagation,\n        shouldCallDirectionHandlerOnlyIsSlide,\n      );\n\n      const eventOptions = { capture: useCapture, passive: false };\n\n      // FIXME: заменить touch/mouse-события ниже на pointer-события после того, как бразуеры из\n      // .browserslistrc начнут поддерживать его (см. https://developer.mozilla.org/en-US/docs/Web/API/Pointer_events#browser_compatibility).\n      if (isTouchEvent(nativeEvent)) {\n        if (isHTMLElement(event.target) || isSVGElement(event.target)) {\n          // Тач-события не всплывают, поэтому навешиваем события на целевой элемент\n          // см. #235, #1968, https://stackoverflow.com/a/45760014\n          const target: HTMLorSVGElementWithEvents = event.target;\n\n          target.addEventListener('touchmove', handleNativePointerMove, eventOptions);\n          target.addEventListener('touchend', handleNativePointerUp, eventOptions);\n          target.addEventListener('touchcancel', handleNativePointerUp, eventOptions);\n\n          disposeTargetNativeGestureEvents.current = () => {\n            target.removeEventListener('touchmove', handleNativePointerMove, eventOptions);\n            target.removeEventListener('touchend', handleNativePointerUp, eventOptions);\n            target.removeEventListener('touchcancel', handleNativePointerUp, eventOptions);\n          };\n        }\n      } else {\n        // Используем события на Document, т.к. mouse-события на целевом элементе могут теряться при\n        // выходе за границы этого элемента.\n        const doc = getWindow(event.currentTarget).document;\n\n        doc.addEventListener('mousemove', handleNativePointerMove, eventOptions);\n        doc.addEventListener('mouseup', handleNativePointerUp, eventOptions);\n        doc.addEventListener('mouseleave', handleNativePointerUp, eventOptions);\n\n        disposeTargetNativeGestureEvents.current = () => {\n          doc.removeEventListener('mousemove', handleNativePointerMove, eventOptions);\n          doc.removeEventListener('mouseup', handleNativePointerUp, eventOptions);\n          doc.removeEventListener('mouseleave', handleNativePointerUp, eventOptions);\n        };\n      }\n    },\n  );\n\n  const handlePointerEnter = onEnter\n    ? (event: React.MouseEvent<HTMLElement>) => onEnter(event.nativeEvent)\n    : undefined;\n\n  const handlePointerLeave = onLeave\n    ? (event: React.MouseEvent<HTMLElement>) => onLeave(event.nativeEvent)\n    : undefined;\n\n  /**\n   * Отменяет нативное браузерное поведение для вложенных ссылок и изображений.\n   */\n  const handleDragStart = (event: React.DragEvent<HTMLElement>) => {\n    const target = event.target as HTMLElement;\n    if (target.tagName === 'A' || target.tagName === 'IMG') {\n      event.preventDefault();\n    }\n  };\n\n  /**\n   * Отменяет переход по вложенной ссылке, если был зафиксирован свайп.\n   */\n  const handleClickCapture: typeof onClickCapture = (event) => {\n    if (!didSlide.current) {\n      return onClickCapture && onClickCapture(event);\n    }\n\n    if (noSlideClick) {\n      event.stopPropagation();\n\n      // https://github.com/VKCOM/VKUI/issues/1977\n      // https://github.com/VKCOM/VKUI/issues/3892\n      event.preventDefault();\n    } else {\n      onClickCapture && onClickCapture(event);\n    }\n\n    didSlide.current = false;\n  };\n\n  useIsomorphicLayoutEffect(\n    function initializeNativeTouchStartEventWithPassiveFalse() {\n      const hostEl = hostRef.current;\n      if (!hostEl || !isTouchEnabled) {\n        return;\n      }\n\n      const options = { capture: useCapture, passive: false };\n      hostEl.addEventListener('touchstart', handlePointerDown, options);\n\n      return () => {\n        hostEl.removeEventListener('touchstart', handlePointerDown, options);\n      };\n    },\n    [hostRef, isTouchEnabled, useCapture, handlePointerDown],\n  );\n\n  return (\n    <Component\n      {...restProps}\n      ref={hostRef}\n      onDragStart={handleDragStart}\n      onClickCapture={handleClickCapture}\n      // onEnter\n      onPointerEnter={usePointerHover ? handlePointerEnter : undefined}\n      onMouseEnter={!usePointerHover ? handlePointerEnter : undefined}\n      // onLeave\n      onPointerLeave={usePointerHover ? handlePointerLeave : undefined}\n      onMouseLeave={!usePointerHover ? handlePointerLeave : undefined}\n      // handlePointerDown(onTouchStart устанавливается отдельно через initializeNativeTouchEventStartWithPassiveFalse)\n      onMouseDownCapture={useCapture ? handlePointerDown : undefined}\n      onMouseDown={!useCapture ? handlePointerDown : undefined}\n    />\n  );\n};\n\nfunction initGesture(startX: number, startY: number): Gesture {\n  return {\n    startX,\n    startY,\n    startT: new Date(),\n    duration: 0,\n    isPressed: true,\n    isY: false,\n    isX: false,\n    isSlideX: false,\n    isSlideY: false,\n    isSlide: false,\n    clientX: 0,\n    clientY: 0,\n    shiftX: 0,\n    shiftY: 0,\n    shiftXAbs: 0,\n    shiftYAbs: 0,\n  };\n}\n\ntype Handlers = [\n  CustomTouchEventHandler | undefined,\n  CustomTouchEventHandler | undefined,\n  CustomTouchEventHandler | undefined,\n];\n\nfunction dispatchUserHandlers(\n  event: MouseEvent | TouchEvent | React.MouseEvent | React.TouchEvent,\n  gesture: Gesture,\n  [handler, handlerX, handlerY]: Handlers,\n  stopPropagation?: boolean,\n  shouldCallDirectionHandlerOnlyIsSlide = true,\n) {\n  if (stopPropagation) {\n    event.stopPropagation();\n  }\n\n  const data = {\n    ...gesture,\n    originalEvent: event as unknown as VKUITouchEvent,\n    duration: Date.now() - gesture.startT.getTime(),\n  };\n\n  if (handler) {\n    handler(data);\n  }\n\n  if (handlerX) {\n    if (shouldCallDirectionHandlerOnlyIsSlide) {\n      if (gesture.isSlideX) {\n        handlerX(data);\n      }\n    } else {\n      handlerX(data);\n    }\n  }\n\n  if (handlerY) {\n    if (shouldCallDirectionHandlerOnlyIsSlide) {\n      if (gesture.isSlideY) {\n        handlerY(data);\n      }\n    } else {\n      handlerY(data);\n    }\n  }\n}\n"],"names":["React","useExternRef","useStableCallback","getWindow","isHTMLElement","isSVGElement","coordX","coordY","touchEnabled","useIsomorphicLayoutEffect","isTouchEvent","event","type","startsWith","useMouseEventLock","isMouseEventLockRef","useRef","timerRef","undefined","isEventLock","useCallback","current","checkEvent","clearTimeout","setTimeout","useEffect","Touch","onStart","onStartX","onStartY","onMove","onMoveX","onMoveY","onEnter","onLeave","onEnd","onEndX","onEndY","onClickCapture","usePointerHover","slideThreshold","useCapture","Component","getRootRef","noSlideClick","stopPropagation","restProps","hostRef","isTouchEnabled","useState","gestureRef","didSlide","disposeTargetNativeGestureEvents","checkEventForLock","cleanupTargetNativeGestureEvents","handleNativePointerUp","gesture","isPressed","dispatchUserHandlers","isSlide","Boolean","handleNativePointerMove","clientX","clientY","shiftX","startX","shiftY","startY","shiftXAbs","Math","abs","shiftYAbs","touches","length","isX","isY","willBeX","willBeY","willBeSlidedX","willBeSlidedY","isSlideX","isSlideY","handlePointerDown","nativeEvent","initGesture","shouldCallDirectionHandlerOnlyIsSlide","eventOptions","capture","passive","target","addEventListener","removeEventListener","doc","currentTarget","document","handlePointerEnter","handlePointerLeave","handleDragStart","tagName","preventDefault","handleClickCapture","initializeNativeTouchStartEventWithPassiveFalse","hostEl","options","ref","onDragStart","onPointerEnter","onMouseEnter","onPointerLeave","onMouseLeave","onMouseDownCapture","onMouseDown","startT","Date","duration","handler","handlerX","handlerY","data","originalEvent","now","getTime"],"mappings":"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"}